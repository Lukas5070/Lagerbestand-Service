<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Etiketten â€“ QR Avery L4743REV</title>
  <style>
    :root{
      --blue:#0d6efd; --green:#28a745; --grey:#6c757d; --bg:#f6f7fb; --bd:#e5e7ef;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;background:var(--bg);color:#222}

    .toolbar{
      position:sticky; top:0; z-index:5;
      background:#fff; border-bottom:1px solid var(--bd);
      padding:10px; display:flex; flex-wrap:wrap; gap:8px; align-items:center;
    }
    .toolbar a, .toolbar button{
      appearance:none; border:1px solid var(--bd); background:#fff; color:#0d6efd;
      padding:8px 12px; border-radius:8px; text-decoration:none; font-weight:600; cursor:pointer;
    }
    .toolbar input[type="date"], .toolbar input[type="text"], .toolbar input[type="number"]{
      padding:8px 10px; border:1px solid #cfd3dc; border-radius:8px; background:#fff;
    }
    .muted{color:#666; font-size:12px}

    .hint{padding:10px 12px}

    /* Druckbereich A4 Avery L4743REV (2x6) */
    @page { size: A4; margin: 0; }
    .seite{
      height: 297mm; width: 210mm;
      padding: 21.5mm 7mm;
      box-sizing: border-box;
      display: grid;
      grid-template-columns: repeat(2, 99.1mm);
      grid-template-rows: repeat(6, 42.3mm);
      gap: 0mm 2.5mm;
      page-break-after: always;
      background:#fff;
    }
    .etikett{
      box-sizing: border-box; padding: 3mm 2mm; text-align: center; overflow: hidden;
      border: 1px dashed transparent; position: relative;
    }
    .etikett img{ height: 32mm; max-width: 100%; margin: 2mm 0 1mm; }
    .etikett small{ display:block; color:#555 }
    .etikett .cb{ position:absolute; left:4px; top:4px; }

    /* Bereiche */
    .druckbereich{ display:block; }
    .druckbereich.ausblenden{ display:none; }

    /* Nicht drucken */
    @media print{
      .noprint, .etikett .cb { display:none!important; }
      body{ background:#fff; }
    }

    /* Liste oben "neuste" */
    .neu-liste{ padding:8px 12px; }
    .neu-item{ display:flex; align-items:center; gap:8px; padding:6px 0; border-bottom:1px solid var(--bd);}
    .neu-item img{ height:30px }
    .neu-item small{ color:#555 }
    .badge{ display:inline-block; padding:2px 6px; border:1px solid var(--bd); border-radius:999px; font-size:12px; color:#444; background:#fff; }
    .grey{ opacity:.5 }
  </style>
</head>
<body>

  <!-- Toolbar -->
  <div class="toolbar noprint">
    <a href="/">â¬… ZurÃ¼ck</a>

    <!-- Modus -->
    <button type="button" onclick="zeigeNurNeue()">ðŸ†• Nur neue</button>
    <button type="button" onclick="zeigeAlle()">ðŸ“¦ Alle</button>

    <!-- Suche -->
    <input id="search" type="text" placeholder="Suchen (Name)â€¦" value="{{ suchbegriff or '' }}" oninput="filterSuche()">

    <!-- Datumsfilter -->
    <span class="muted">Von</span>
    <input id="from" type="date" value="{{ date_from or '' }}">
    <span class="muted">Bis</span>
    <input id="to" type="date" value="{{ date_to or '' }}">
    <button type="button" onclick="anwenden()">Anwenden</button>
    <button type="button" onclick="seitLetztemDruck()">Seit letztem Druck</button>
    <span id="lastInfo" class="muted"></span>

    <!-- Auswahl -->
    <button type="button" onclick="sichtbareAuswaehlen()">âœ” Sichtbare auswÃ¤hlen</button>
    <button type="button" onclick="auswahlAufheben()">âœ– Auswahl aufheben</button>

    <!-- Kopien -->
    <span class="muted">Kopien/Etikett</span>
    <input id="copies" type="number" min="1" step="1" value="1" style="width:70px">

    <!-- Drucken -->
    <button type="button" onclick="druckeNurAuswahl()">ðŸŸ¡ Nur Auswahl drucken</button>
    <button type="button" onclick="druckeAlles()">ðŸŸ¢ Jetzt drucken</button>
  </div>

  <div class="hint noprint">
    <span class="badge">Tipp</span> WÃ¤hle einen Zeitraum (Von/Bis) und drucke nur diese neuen Etiketten. Nach dem Druck merkt sich die Seite das Datum (â€žSeit letztem Druckâ€œ).
  </div>

  <!-- KurzÃ¼bersicht der neuen (nicht druckbar) -->
  <div class="neu-liste noprint" id="liste-neu">
    <h3>ðŸ†• Zuletzt hinzugefÃ¼gt (nach Datumfilter)</h3>
    {% if neue_artikel %}
      {% for art in neue_artikel %}
        <div class="neu-item" data-name="{{ (art.name or '')|lower }}">
          <img src="{{ url_for('static', filename='barcodes/' + art.barcode_filename) }}" alt="QR">
          <div>
            <div><strong>{{ art.name }}</strong></div>
            <small>ID: {{ art.barcode_filename[:-4] }} Â·
              HinzugefÃ¼gt: {{ art.created_at.strftime('%d.%m.%Y %H:%M') if art.created_at else 'â€“' }}
            </small>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p class="muted">Keine Artikel im gewÃ¤hlten Zeitraum.</p>
    {% endif %}
  </div>

  <!-- Druckbereiche -->
  <div id="nur-neue" class="druckbereich">
    {% for i in range(0, neue_artikel|length, 12) %}
      <div class="seite">
        {% for art in neue_artikel[i:i+12] %}
          <div class="etikett"
               data-id="{{ art.barcode_filename[:-4] }}"
               data-name="{{ (art.name or '')|lower }}"
               data-created="{{ art.created_at.isoformat() if art.created_at else '' }}">
            <label class="cb noprint"><input type="checkbox" class="sel"> auswÃ¤hlen</label>
            <strong>{{ art.name }}</strong><br>
            <img src="{{ url_for('static', filename='barcodes/' + art.barcode_filename) }}" alt="QR"><br>
            <small>{{ art.barcode_filename[:-4] }}</small>
          </div>
        {% endfor %}
      </div>
    {% endfor %}
  </div>

  <div id="alle-artikel" class="druckbereich ausblenden">
    {% for i in range(0, artikel|length, 12) %}
      <div class="seite">
        {% for art in artikel[i:i+12] %}
          <div class="etikett"
               data-id="{{ art.barcode_filename[:-4] }}"
               data-name="{{ (art.name or '')|lower }}"
               data-created="{{ art.created_at.isoformat() if art.created_at else '' }}">
            <label class="cb noprint"><input type="checkbox" class="sel"> auswÃ¤hlen</label>
            <strong>{{ art.name }}</strong><br>
            <img src="{{ url_for('static', filename='barcodes/' + art.barcode_filename) }}" alt="QR"><br>
            <small>{{ art.barcode_filename[:-4] }}</small>
          </div>
        {% endfor %}
      </div>
    {% endfor %}
  </div>

  <!-- Unsichtbarer Container zum Druck der Auswahl/Kopien -->
  <div id="print-only" style="display:none"></div>

  <script>
    // --- Sicht umschalten ---
    function zeigeNurNeue(){ document.getElementById('nur-neue').classList.remove('ausblenden'); document.getElementById('alle-artikel').classList.add('ausblenden'); }
    function zeigeAlle(){ document.getElementById('alle-artikel').classList.remove('ausblenden'); document.getElementById('nur-neue').classList.add('ausblenden'); }

    // --- Suche (nur in Ansicht wirksam, nicht serverseitig) ---
    function filterSuche(){
      const q = (document.getElementById('search').value || '').toLowerCase();
      ['nur-neue','alle-artikel'].forEach(id=>{
        const root = document.getElementById(id);
        const etiketten = root.querySelectorAll('.etikett');
        etiketten.forEach(el=>{
          const name = el.getAttribute('data-name') || '';
          el.style.display = (!q || name.indexOf(q) >= 0) ? '' : 'none';
        });
      });
      // Liste oben ebenfalls filtern
      document.querySelectorAll('#liste-neu .neu-item').forEach(li=>{
        const name = li.getAttribute('data-name') || '';
        li.style.display = (!q || name.indexOf(q) >= 0) ? '' : 'none';
      });
    }

    // --- Datumsfilter anwenden (lÃ¤dt Seite neu mit Parametern) ---
    function anwenden(){
      const f = document.getElementById('from').value;
      const t = document.getElementById('to').value;
      const q = document.getElementById('search').value;
      const params = new URLSearchParams();
      if (f) params.set('from', f);
      if (t) params.set('to', t);
      if (q) params.set('q', q);
      location.href = '/barcodes' + (params.toString() ? '?' + params.toString() : '');
    }

    // --- "Seit letztem Druck" (per localStorage) ---
    function seitLetztemDruck(){
      const last = localStorage.getItem('lastPrintDate'); // ISO yyyy-mm-dd
      const today = new Date();
      const fmt = d => d.toISOString().slice(0,10);
      document.getElementById('from').value = last || fmt(new Date(today.getFullYear(), today.getMonth(), today.getDate()-7));
      document.getElementById('to').value   = fmt(today);
    }
    (function initLastInfo(){
      const last = localStorage.getItem('lastPrintDate');
      if (last){
        document.getElementById('lastInfo').textContent = `Letzter Druck: ${last}`;
      }
    })();

    // --- Auswahl-Helper ---
    function _currentRoot(){
      return document.getElementById('nur-neue').classList.contains('ausblenden')
        ? document.getElementById('alle-artikel')
        : document.getElementById('nur-neue');
    }
    function sichtbareAuswaehlen(){
      _currentRoot().querySelectorAll('.etikett').forEach(el=>{
        if (el.style.display !== 'none'){
          const cb = el.querySelector('.sel'); if (cb) cb.checked = true;
        }
      });
    }
    function auswahlAufheben(){
      document.querySelectorAll('.sel').forEach(cb=> cb.checked = false);
    }

    // --- Drucken ---
    function _collectToPrint(onlySelected){
      const root = _currentRoot();
      const copies = Math.max(1, parseInt(document.getElementById('copies').value || '1', 10));
      const nodes = root.querySelectorAll('.etikett');
      const out = document.getElementById('print-only');
      out.innerHTML = '';

      // neue Seite im Avery-Layout aufbauen
      let page = null, countOnPage = 0;

      let maxCreated = null;
      nodes.forEach(el=>{
        const selected = el.querySelector('.sel')?.checked;
        if (onlySelected && !selected) return;
        if (el.style.display === 'none') return;

        const created = el.getAttribute('data-created');
        if (created){
          const d = new Date(created);
          if (!isNaN(d)) maxCreated = (!maxCreated || d > maxCreated) ? d : maxCreated;
        }

        for (let i=0;i<copies;i++){
          if (!page || countOnPage >= 12){
            page = document.createElement('div');
            page.className = 'seite';
            out.appendChild(page);
            countOnPage = 0;
          }
          const clone = el.cloneNode(true);
          clone.querySelectorAll('.cb').forEach(c=>c.remove()); // Checkboxen nicht drucken
          page.appendChild(clone);
          countOnPage++;
        }
      });

      return maxCreated;
    }

    function druckeNurAuswahl(){
      const maxCreated = _collectToPrint(true);
      window.print();
      if (maxCreated){
        // yyyy-mm-dd speichern
        const iso = maxCreated.toISOString().slice(0,10);
        localStorage.setItem('lastPrintDate', iso);
        document.getElementById('lastInfo').textContent = `Letzter Druck: ${iso}`;
      }
      document.getElementById('print-only').innerHTML = '';
    }

    function druckeAlles(){
      const maxCreated = _collectToPrint(false);
      window.print();
      if (maxCreated){
        const iso = maxCreated.toISOString().slice(0,10);
        localStorage.setItem('lastPrintDate', iso);
        document.getElementById('lastInfo').textContent = `Letzter Druck: ${iso}`;
      }
      document.getElementById('print-only').innerHTML = '';
    }

    // initiale Suche anwenden, falls Query gesetzt
    filterSuche();
  </script>

</body>
</html>
