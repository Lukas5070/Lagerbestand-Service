<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Etiketten ‚Äì QR Avery L4743REV</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      font-size: 12px;
      background: #fff;
    }

    /* ---- Toolbar ---- */
    .noprint { padding: 10px; border-bottom: 1px solid #e5e5e5; background:#fafafa; position: sticky; top: 0; z-index: 5; }
    .toolbar { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .btn { padding: 6px 12px; border: none; border-radius: 5px; cursor: pointer; text-decoration: none; display: inline-block; background:#f0f0f0; }
    .btn-blue { background:#007BFF; color:#fff; }
    .btn-teal { background:#17a2b8; color:#fff; }
    .btn-grey { background:#6c757d; color:#fff; }
    .btn-green { background:#28a745; color:#fff; }
    .btn-amber { background:#ffc107; color:#000; }
    .toolbar input[type="text"], .toolbar input[type="number"] {
      padding: 6px 8px; border: 1px solid #ccc; border-radius: 4px;
    }
    .hint { margin:6px 0 0 2px; color:#555 }

    /* ---- Info ‚ÄûZuletzt hinzugef√ºgt‚Äú ---- */
    .neu-artikel { margin: 10px; padding: 10px; background: #f8f9fa; border: 1px solid #ccc; border-radius: 5px; }
    .neu-eintrag { margin-bottom: 6px; }
    .neu-eintrag img { height: 42px; vertical-align: middle; margin-right: 10px; }

    /* ---- Bildschirm-Liste (interaktiv) ---- */
    .screen-list { padding: 10px; }
    .item { display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #eee; padding: 8px 0; }
    .item .chk { transform: scale(1.2); }
    .item .preview { width: 38px; height: 38px; border:1px solid #ddd; border-radius:4px; display:flex; align-items:center; justify-content:center; overflow:hidden; background:#fff; }
    .item .preview img { max-width:100%; max-height:100%; display:block; }
    .item .name { font-weight: bold; }
    .item .meta { color:#666; font-size: 11px; }

    .hidden { display: none !important; }

    /* ---- Druckraster (nur im Druck sichtbar) ---- */
    @media print {
      .noprint, .screen-list, .neu-artikel { display: none !important; }
      .print-area { display: block !important; }
    }
    .print-area { display: none; } /* am Bildschirm versteckt */

    /* Avery L4743REV ‚Äì 2 Spalten √ó 6 Reihen = 12 Etiketten */
    .seite {
      height: 297mm; width: 210mm;
      padding: 21.5mm 7mm;
      box-sizing: border-box;
      display: grid;
      grid-template-columns: repeat(2, 99.1mm);
      grid-template-rows: repeat(6, 42.3mm);
      gap: 0mm 2.5mm;
      page-break-after: always;
    }
    .etikett {
      box-sizing: border-box; padding: 3mm 2mm; text-align: center; overflow: hidden;
    }
    .etikett img { height: 32mm; max-width: 100%; margin: 2mm 0 1mm; }
    .meta-label { font-size: 10px; color: #555; line-height: 1.2; }
    .badge { display:inline-block; padding:2px 6px; border-radius:4px; background:#eee; font-size:10px; color:#333; }
  </style>
</head>
<body>

  <!-- Toolbar -->
  <div class="noprint">
    <div class="toolbar">
      <a href="/" class="btn btn-blue">‚¨Ö Zur√ºck</a>

      <input type="text" id="suchfeld" placeholder="üîç Suche: Name, ID, Lagerplatz ‚Ä¶" oninput="filterList()">

      <button type="button" class="btn btn-teal" onclick="switchMode('neu')">üÜï Nur neue</button>
      <button type="button" class="btn btn-grey" onclick="switchMode('alle')">üì¶ Alle</button>

      <button type="button" class="btn btn-grey" onclick="selectVisible(true)">‚òëÔ∏è Sichtbare ausw√§hlen</button>
      <button type="button" class="btn btn-grey" onclick="selectVisible(false)">üî≤ Auswahl aufheben</button>

      <label for="kopien">Kopien pro ausgew√§hltem Etikett:</label>
      <input type="number" id="kopien" min="1" value="1" style="width:70px">

      <button type="button" class="btn btn-amber" onclick="buildAndPrint(true)">‚úÖ Nur Auswahl drucken</button>
      <button type="button" class="btn btn-green" onclick="buildAndPrint(false)">üñ®Ô∏è Jetzt drucken</button>
    </div>
    <p class="hint">Druckeinstellungen: A4 ¬∑ 100 % ¬∑ Keine R√§nder ¬∑ Hintergrundgrafiken ‚úÖ</p>
  </div>

  <!-- Info ‚ÄûZuletzt hinzugef√ºgt‚Äú -->
  <div class="noprint neu-artikel">
    <strong>üÜï Zuletzt hinzugef√ºgt</strong>
    <div>
      {% if neue_artikel %}
        {% for art in neue_artikel %}
          <div class="neu-eintrag">
            <img src="{{ url_for('static', filename='barcodes/' + art.barcode_filename) }}" alt="Barcode">
            <strong>{{ art.name }}</strong>
            <small>
              &nbsp;|&nbsp;ID: {{ art.barcode_filename[:-4] }}&nbsp;|&nbsp;
              Hinzugef√ºgt:
              {% if art.created_at and art.created_at.strftime %}
                {{ art.created_at.strftime('%d.%m.%Y %H:%M') }}
              {% else %}‚Äì{% endif %}
            </small>
          </div>
        {% endfor %}
      {% else %}
        <em>Keine neuen Artikel gefunden.</em>
      {% endif %}
    </div>
  </div>

  <!-- Bildschirm-Liste: ALLE -->
  <div id="list-alle" class="screen-list">
    {% for art in artikel %}
      <div class="item"
           data-name="{{ art.name|lower }}"
           data-id="{{ art.barcode_filename[:-4]|lower }}"
           data-lagerplatz="{{ (art.lagerplatz or '')|lower }}">
        <input type="checkbox" class="chk">
        <div class="preview">
          <img src="{{ url_for('static', filename='barcodes/' + art.barcode_filename) }}" alt="QR">
        </div>
        <div>
          <div class="name">{{ art.name }}</div>
          <div class="meta">
            <span>ID: {{ art.barcode_filename[:-4] }}</span>
            {% if art.lagerplatz %} &nbsp;‚Ä¢&nbsp; <span>Lagerplatz: {{ art.lagerplatz }}</span>{% endif %}
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <!-- Bildschirm-Liste: NUR neue -->
  <div id="list-neu" class="screen-list hidden">
    {% for art in neue_artikel %}
      <div class="item"
           data-name="{{ art.name|lower }}"
           data-id="{{ art.barcode_filename[:-4]|lower }}"
           data-lagerplatz="{{ (art.lagerplatz or '')|lower }}">
        <input type="checkbox" class="chk">
        <div class="preview">
          <img src="{{ url_for('static', filename='barcodes/' + art.barcode_filename) }}" alt="QR">
        </div>
        <div>
          <div class="name">{{ art.name }}</div>
          <div class="meta">
            <span>ID: {{ art.barcode_filename[:-4] }}</span>
            {% if art.lagerplatz %} &nbsp;‚Ä¢&nbsp; <span>Lagerplatz: {{ art.lagerplatz }}</span>{% endif %}
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <!-- Druck-Container (wird per JS gef√ºllt) -->
  <div id="print-area" class="print-area"></div>

  <script>
    var mode = 'alle'; // 'alle' | 'neu'

    function switchMode(m) {
      mode = m;
      document.getElementById('list-alle').classList.toggle('hidden', m !== 'alle');
      document.getElementById('list-neu').classList.toggle('hidden', m !== 'neu');
      filterList(); // Filter nach Umschalten erneut anwenden
      window.scrollTo(0,0);
    }

    function currentList() {
      return (mode === 'neu') ? document.getElementById('list-neu') : document.getElementById('list-alle');
    }

    function filterList() {
      var q = (document.getElementById('suchfeld').value || '').toLowerCase();
      var list = currentList();
      var items = list.querySelectorAll('.item');
      for (var i=0; i<items.length; i++) {
        var it = items[i];
        var name = it.getAttribute('data-name') || '';
        var id = it.getAttribute('data-id') || '';
        var lp = it.getAttribute('data-lagerplatz') || '';
        var show = !q || name.indexOf(q) !== -1 || id.indexOf(q) !== -1 || lp.indexOf(q) !== -1;
        it.style.display = show ? '' : 'none';
      }
    }

    function selectVisible(checked) {
      var list = currentList();
      var items = list.querySelectorAll('.item');
      for (var i=0; i<items.length; i++) {
        var it = items[i];
        if (it.style.display !== 'none') {
          var cb = it.querySelector('.chk');
          if (cb) cb.checked = checked;
        }
      }
    }

    function buildAndPrint(onlySelected) {
      var list = currentList();
      var items = list.querySelectorAll('.item');
      var kopien = parseInt(document.getElementById('kopien').value, 10);
      if (isNaN(kopien) || kopien < 1) kopien = 1;

      var rows = [];
      for (var i=0; i<items.length; i++) {
        var it = items[i];
        if (it.style.display === 'none') continue;
        var cb = it.querySelector('.chk');
        if (onlySelected && (!cb || !cb.checked)) continue;

        var name = it.getAttribute('data-name') || '';
        // F√ºr Druck den originalen (nicht-lowercase) Namen verwenden:
        var nameText = it.querySelector('.name') ? it.querySelector('.name').textContent : name;
        var id = it.getAttribute('data-id') || '';
        var lp = it.getAttribute('data-lagerplatz') || '';
        var img = it.querySelector('img') ? it.querySelector('img').getAttribute('src') : '';

        for (var k=0; k<kopien; k++) {
          rows.push({name: nameText, id: id, lp: lp, img: img});
        }
      }

      if (rows.length === 0) {
        alert(onlySelected ? 'Bitte w√§hle mindestens ein Etikett aus.' : 'Keine Etiketten gefunden.');
        return;
      }

      // Druckraster aufbauen
      var container = document.getElementById('print-area');
      container.innerHTML = '';
      for (var p=0; p<rows.length; p+=12) {
        var seite = document.createElement('div');
        seite.className = 'seite';
        var slice = rows.slice(p, p+12);
        for (var j=0; j<slice.length; j++) {
          var it = slice[j];
          var card = document.createElement('div');
          card.className = 'etikett';
          card.innerHTML =
            '<strong>' + esc(it.name) + '</strong><br>' +
            '<img src="' + esc(it.img) + '" alt="Barcode"><br>' +
            '<div class="meta-label">' +
              '<span class="badge">ID: ' + esc(it.id) + '</span>' +
              (it.lp ? '&nbsp;‚Ä¢&nbsp;Lagerplatz: ' + esc(it.lp) : '') +
            '</div>';
          seite.appendChild(card);
        }
        container.appendChild(seite);
      }

      // Drucken
      window.print();
    }

    function esc(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#039;');
    }
  </script>
</body>
</html>
