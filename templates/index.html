<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Lagerbestand</title>
  <style>
    :root{
      --blue:#0d6efd; --green:#28a745; --amber:#ffc107; --red:#dc3545;
      --bg:#f6f7fb; --card:#fff; --bd:#e5e7ef; --text:#222;
    }
    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}

    h1{margin:20px 16px 8px;font-size:28px;line-height:1.2}
    .top-links{margin:0 16px 12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .top-links a{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:8px;background:var(--card);border:1px solid var(--bd);text-decoration:none;color:var(--blue);font-weight:600}

    .controls{margin:0 16px 14px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .controls input[type="text"], .controls select{padding:10px 12px;border:1px solid #cfd3dc;border-radius:8px;background:#fff;min-width:220px}

    .tablewrap{margin:0 16px 20px;background:var(--card);border:1px solid var(--bd);border-radius:10px;overflow:hidden;box-shadow:0 1px 6px rgba(0,0,0,.05)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px;border-bottom:1px solid #eef0f6;text-align:center;vertical-align:middle}
    thead th{background:var(--blue);color:#fff;cursor:pointer;user-select:none}
    thead th.nosort{cursor:default}
    thead th.asc::after{content:" ‚ñ≤"} thead th.desc::after{content:" ‚ñº"}

    .btn{display:inline-block;padding:6px 10px;border-radius:6px;color:#fff;text-decoration:none;margin:2px;font-size:.9em}
    .btn-edit{background:#28a745}
    .btn-delete{background:#dc3545}
    .btn-order{background:#17a2b8}
    .inline-form{display:inline}

    .status-green{color:#28a745;font-weight:700}
    .status-yellow{color:#c58a00;font-weight:700}
    .status-red{color:#dc3545;font-weight:700}

    .qrbox{display:flex;flex-direction:column;align-items:center;gap:4px}
    .qrbox img{height:50px;width:auto;display:block}
    .qrid{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;color:#555;background:#f6f6f6;border:1px solid #e0e0e0;border-radius:4px;padding:2px 6px;white-space:nowrap}

    .note{
      text-align:left; max-width:420px; margin:0 auto; color:#1f2937;
      line-height:1.35; word-break:break-word; white-space:normal;
    }
    .note .badge{display:inline-block;background:#fff3cd;border:1px solid #ffe69c;color:#7a5d00;border-radius:999px;padding:2px 8px;font-size:12px;margin-right:6px}
    .muted{color:#6b7280}

    tr:target{outline:3px solid var(--blue);background:#e8f1ff}

    /* Mobile ‚Üí Karten */
    @media (max-width: 768px){
      .top-links a{flex:1 1 100%}
      .controls{flex-direction:column;align-items:stretch}
      .controls input[type="text"], .controls select{width:100%;min-width:0}

      table thead{display:none}
      table, tbody, tr, td{display:block;width:100%}
      tbody tr{border-bottom:0;margin:12px 12px;border:1px solid var(--bd);border-radius:10px;background:#fff;overflow:hidden}
      td{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #f0f2f8}
      td:last-child{border-bottom:none}
      td::before{content:attr(data-label);font-weight:600;color:#667085;margin-right:12px;flex:0 0 auto}
      td[data-label="Aktionen"]{flex-wrap:wrap;gap:8px}
      .btn{padding:10px 12px;font-size:16px}
      .qrbox img{height:42px}
      .note{max-width:unset;text-align:right}
    }
  </style>

  <script>
    function searchTable() {
      var q = (document.getElementById("searchInput").value || "").toLowerCase().trim();
      var filterValue = document.getElementById("statusFilter").value;
      var rows = document.querySelectorAll("tbody tr");
      for (var i=0;i<rows.length;i++){
        var r = rows[i];
        var name = r.getAttribute("data-name") || "";
        var lp   = r.getAttribute("data-lagerplatz") || "";
        var id   = r.getAttribute("data-id") || "";
        var status = r.getAttribute("data-status") || "";
        var okQ = !q || name.indexOf(q)>-1 || lp.indexOf(q)>-1 || id.indexOf(q)>-1;
        var okF = (filterValue==="alle") || (status===filterValue);
        r.style.display = (okQ && okF) ? "" : "none";
      }
    }
    function sortTable(colIndex){
      var tbody = document.querySelector("tbody");
      var rows = Array.prototype.slice.call(tbody.rows);
      var headers = document.querySelectorAll("thead th");
      var header = headers[colIndex];
      if (!header || header.classList.contains("nosort")) return;
      var isAsc = header.classList.contains("asc");
      for (var h=0;h<headers.length;h++){ headers[h].classList.remove("asc","desc"); }
      rows.sort(function(a,b){
        var A = (a.cells[colIndex].innerText || "").trim().toLowerCase();
        var B = (b.cells[colIndex].innerText || "").trim().toLowerCase();
        var nA = parseFloat(A.replace(",", ".")); var nB = parseFloat(B.replace(",", "."));
        if (!isNaN(nA) && !isNaN(nB)) return isAsc ? (nA-nB) : (nB-nA);
        return isAsc ? A.localeCompare(B) : B.localeCompare(A);
      });
      for (var i=0;i<rows.length;i++){ tbody.appendChild(rows[i]); }
      header.classList.toggle("asc", !isAsc);
      header.classList.toggle("desc", isAsc);
    }
  </script>
</head>
<body>
  <h1>üì¶ Lagerbestand</h1>

  <div class="top-links">
    <a href="/add">‚ûï Artikel hinzuf√ºgen</a>
    <a href="/barcodes">üè∑Ô∏è Barcodes drucken</a>
    <a href="/scan">üì∑ Barcode scannen</a>
    <a href="/export.csv?sep=semicolon&encoding=utf-8&bom=1">üì§ CSV-Export</a>
  </div>

  <div class="controls">
    üîé <input type="text" id="searchInput" oninput="searchTable()" placeholder="Artikel, Lagerplatz oder Barcode-ID suchen‚Ä¶">
    üìä <label for="statusFilter">Filter:</label>
    <select id="statusFilter" onchange="searchTable()">
      <option value="alle">Alle</option>
      <option value="kritisch">Nur kritische</option>
      <option value="knapp">Nur knappe</option>
    </select>
  </div>

  <div class="tablewrap">
    <table>
      <thead>
        <tr>
          <th onclick="sortTable(0)">Name</th>
          <th onclick="sortTable(1)">Bestand</th>
          <th onclick="sortTable(2)">Mindestbestand</th>
          <th class="nosort">Status</th>
          <th onclick="sortTable(4)">Lagerplatz</th>
          <th class="nosort">Hinweis</th>  <!-- üÜï -->
          <th class="nosort">Barcode</th>
          <th class="nosort">Aktionen</th>
        </tr>
      </thead>
      <tbody>
        {% for art in artikel %}
          {% set id_plain = art.barcode_filename[:-4] %}
          {% set status_txt = 'kritisch' if art.bestand < art.mindestbestand else ('knapp' if art.bestand == art.mindestbestand else 'ausreichend') %}
          <tr id="art-{{ art.id }}"
              data-name="{{ (art.name or '')|lower }}"
              data-lagerplatz="{{ (art.lagerplatz or '')|lower }}"
              data-id="{{ id_plain|lower }}"
              data-status="{{ status_txt }}">
            <td data-label="Name">{{ art.name }}</td>
            <td data-label="Bestand">{{ art.bestand }}</td>
            <td data-label="Mindestbestand">{{ art.mindestbestand }}</td>
            <td data-label="Status">
              {% if art.bestand < art.mindestbestand %}
                <span class="status-red">üî¥ kritisch</span>
              {% elif art.bestand == art.mindestbestand %}
                <span class="status-yellow">üü° knapp</span>
              {% else %}
                <span class="status-green">üü¢ ausreichend</span>
              {% endif %}
            </td>
            <td data-label="Lagerplatz">{{ art.lagerplatz or '-' }}</td>
            <td data-label="Hinweis">
              {% if art.hinweis %}
                <div class="note" title="{{ art.hinweis }}">
                  <span class="badge">‚ö†Ô∏é Hinweis</span>{{ art.hinweis }}
                </div>
              {% else %}
                <span class="muted">‚Äì</span>
              {% endif %}
            </td>
            <td data-label="Barcode">
              <div class="qrbox">
                <img src="{{ url_for('static', filename='barcodes/' + art.barcode_filename) }}" alt="QR">
                <span class="qrid">{{ id_plain }}</span>
              </div>
            </td>
            <td data-label="Aktionen">
              <a href="{{ url_for('edit', id=art.id) }}" class="btn btn-edit">‚úèÔ∏è Bearbeiten</a>
              <form action="{{ url_for('delete', id=art.id) }}" method="post" class="inline-form" onsubmit="return confirm('Wirklich l√∂schen?');">
                <button type="submit" class="btn btn-delete">üóëÔ∏è L√∂schen</button>
              </form>
              {% if art.bestelllink %}
                <a href="{{ art.bestelllink }}" target="_blank" rel="noopener" class="btn btn-order">üîó Bestellen</a>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</body>
</html>
