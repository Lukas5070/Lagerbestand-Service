<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Lagerbestand</title>
  <style>
    :root{
      --blue:#0d6efd; --green:#28a745; --amber:#ffc107; --red:#dc3545;
      --bg:#f5f5f5; --card:#fff; --bd:#e5e5e5; --text:#222;
    }
    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    html,body{margin:0;padding:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}
    h1{margin:24px 24px 8px 24px;font-size:28px}
    .top-links{margin:0 24px 16px 24px;display:flex;gap:16px;flex-wrap:wrap;align-items:center}
    .top-links a{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:6px;background:#fff;border:1px solid var(--bd);text-decoration:none;color:var(--blue);font-weight:600}
    .controls{margin:0 24px 16px 24px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .controls input[type="text"], .controls select{padding:10px;border:1px solid #ccc;border-radius:6px;background:#fff}

    .tablewrap{margin:0 24px 24px 24px;background:var(--card);border:1px solid var(--bd);border-radius:8px;overflow:hidden;box-shadow:0 1px 6px rgba(0,0,0,.05)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px;border-bottom:1px solid #eee;text-align:center;vertical-align:middle}
    thead th{background:var(--blue);color:#fff;cursor:pointer;user-select:none}
    thead th.nosort{cursor:default}
    thead th.asc::after{content:" ▲";} thead th.desc::after{content:" ▼";}
    .inline-form{display:inline}
    .btn{display:inline-block;padding:6px 10px;border-radius:4px;color:#fff;text-decoration:none;margin:2px;font-size:.9em}
    .btn-edit{background:#28a745}
    .btn-delete{background:#dc3545}
    .btn-order{background:#17a2b8}
    .status-green{color:#28a745;font-weight:700}
    .status-yellow{color:#c58a00;font-weight:700}
    .status-red{color:#dc3545;font-weight:700}

    /* Markiere die Zeile, zu der der Hash zeigt */
    tr:target { outline: 3px solid #0d6efd; background: #e8f1ff; }
  </style>

  <script>
    function searchTable() {
      var q = (document.getElementById("searchInput").value || "").toLowerCase().trim();
      var filterValue = document.getElementById("statusFilter").value; // 'alle' | 'kritisch' | 'knapp'
      var rows = document.querySelectorAll("tbody tr");
      for (var i=0;i<rows.length;i++){
        var r = rows[i];
        var name = r.getAttribute("data-name") || "";
        var lp   = r.getAttribute("data-lagerplatz") || "";
        var id   = r.getAttribute("data-id") || "";
        var status = r.getAttribute("data-status") || "";
        var okQ = !q || name.indexOf(q)>-1 || lp.indexOf(q)>-1 || id.indexOf(q)>-1;
        var okF = (filterValue==="alle") || (status===filterValue);
        r.style.display = (okQ && okF) ? "" : "none";
      }
    }
    function sortTable(colIndex){
      var tbody = document.querySelector("tbody");
      var rows = Array.prototype.slice.call(tbody.rows);
      var headers = document.querySelectorAll("thead th");
      var header = headers[colIndex];
      if (header.classList.contains("nosort")) return;

      var isAsc = header.classList.contains("asc");
      for (var h=0;h<headers.length;h++){ headers[h].classList.remove("asc","desc"); }

      rows.sort(function(a,b){
        var A = (a.cells[colIndex].innerText || "").trim().toLowerCase();
        var B = (b.cells[colIndex].innerText || "").trim().toLowerCase();
        var nA = parseFloat(A.replace(",", ".")); var nB = parseFloat(B.replace(",", "."));
        if (!isNaN(nA) && !isNaN(nB)) return isAsc ? (nA-nB) : (nB-nA);
        return isAsc ? A.localeCompare(B) : B.localeCompare(A);
      });

      for (var i=0;i<rows.length;i++){ tbody.appendChild(rows[i]); }
      header.classList.toggle("asc", !isAsc);
      header.classList.toggle("desc", isAsc);
    }
  </script>
</head>
<body>
  <h1>📦 Lagerbestand</h1>

  <div class="top-links">
    <a href="/add">➕ Artikel hinzufügen</a>
    <a href="/barcodes">🏷️ Barcodes drucken</a>
    <a href="/scan">📷 Barcode scannen</a>
  </div>

  <div class="controls">
    🔍 <input type="text" id="searchInput" oninput="searchTable()" placeholder="Artikel, Lagerplatz oder Barcode-ID suchen…">
    📊 <label for="statusFilter">Filter:</label>
    <select id="statusFilter" onchange="searchTable()">
      <option value="alle">Alle</option>
      <option value="kritisch">Nur kritische</option>
      <option value="knapp">Nur knappe</option>
    </select>
  </div>

  <div class="tablewrap">
    <table>
      <thead>
        <tr>
          <th onclick="sortTable(0)">Name</th>
          <th onclick="sortTable(1)">Bestand</th>
          <th onclick="sortTable(2)">Mindestbestand</th>
          <th class="nosort">Status</th>
          <th onclick="sortTable(4)">Lagerplatz</th>
          <th onclick="sortTable(5)">Barcode-ID</th>
          <th class="nosort">Aktionen</th>
        </tr>
      </thead>
      <tbody>
        {% for art in artikel %}
          {% set id_plain = art.barcode_filename[:-4] %}
          {% set status_txt = 'kritisch' if art.bestand < art.mindestbestand else ('knapp' if art.bestand == art.mindestbestand else 'ausreichend') %}
          <tr id="art-{{ art.id }}"
              data-name="{{ (art.name or '')|lower }}"
              data-lagerplatz="{{ (art.lagerplatz or '')|lower }}"
              data-id="{{ id_plain|lower }}"
              data-status="{{ status_txt }}">
            <td>{{ art.name }}</td>
            <td>{{ art.bestand }}</td>
            <td>{{ art.mindestbestand }}</td>
            <td>
              {% if art.bestand < art.mindestbestand %}
                <span class="status-red">🔴 kritisch</span>
              {% elif art.bestand == art.mindestbestand %}
                <span class="status-yellow">🟡 knapp</span>
              {% else %}
                <span class="status-green">🟢 ausreichend</span>
              {% endif %}
            </td>
            <td>{{ art.lagerplatz or '-' }}</td>
            <td><code>{{ id_plain }}</code></td>
            <td>
              <a href="{{ url_for('edit', id=art.id) }}" class="btn btn-edit">✏️ Bearbeiten</a>
              <form action="{{ url_for('delete', id=art.id) }}" method="post" class="inline-form" onsubmit="return confirm('Wirklich löschen?');">
                <button type="submit" class="btn btn-delete">🗑️</button>
              </form>
              {% if art.bestelllink %}
                <a href="{{ art.bestelllink }}" target="_blank" rel="noopener" class="btn btn-order">🔗 Bestellen</a>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</body>
</html>
